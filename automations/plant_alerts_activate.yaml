- id: '1760852852320'
  alias: Plant Alerts - Activate (Morning Check)
  description: >
    Morning plant health check that turns lights red for any plants needing water.
    Runs once per day at 7am local time. Only affects lights for plants with problems.
    Sends notification summary if any plants need attention.
  trigger:
  - platform: time
    at: '07:00:00'
  action:
  - variables:
      problematic_plants: >
        {% set probs = [] %}
        {% for p in plants %}
          {% set moist = states(p.moisture_sensor) | float(-1) %}
          {% set batt = states(p.battery_sensor) | float(100) %}
          {% set has_problem = (moist >= 0 and moist < moisture_threshold) or (batt < 100 and batt < battery_threshold) %}
          {% if has_problem %}
            {% set probs = probs + ([p.name ~ ': Low moisture ' ~ moist ~ '% / Battery ' ~ batt ~ '%']) %}
          {% endif %}
        {% endfor %}
        {{ probs }}
      unique_lights: >-
        {% set lights = namespace(list=[]) %}
        {% for p in plants %}
          {% if p.light not in lights.list %}
            {% set lights.list = lights.list + [p.light] %}
          {% endif %}
        {% endfor %}
        {{ lights.list }}
  - repeat:
      for_each: '{{ unique_lights }}'
      sequence:
      - variables:
          current_light: '{{ repeat.item }}'
          light_has_problem: >-
            {% set any_problem = false %}
            {% for p in plants %}
              {% if p.light == current_light %}
                {% set moist = states(p.moisture_sensor) | float(-1) %}
                {% set batt = states(p.battery_sensor) | float(100) %}
                {% if (moist >= 0 and moist < moisture_threshold) or (batt < 100 and batt < battery_threshold) %}
                  {% set any_problem = true %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {{ any_problem }}
      - choose:
        - conditions:
          - condition: template
            value_template: '{{ light_has_problem }}'
          sequence:
          - target:
              entity_id: '{{ current_light }}'
            data:
              color_name: '{{ alert_color }}'
              brightness: '{{ brightness }}'
            action: light.turn_on
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ problematic_plants | length > 0 }}'
      sequence:
      - data:
          title: "ðŸŒ¿ Plant Alerts"
          message: >
            {{ problematic_plants | join('
            ') }}
          notification_id: plant_alert_summary
        action: persistent_notification.create
      - data:
          title: "ðŸŒ¿ Plant Alerts"
          message: '{{ problematic_plants | join('', '') }}'
          data:
            color: red
            tag: plant_alert_summary
            sticky: true
            importance: high
        action: notify.mobile_app_chriss_iphone_2
  mode: restart
  variables:
    alert_color: red
    brightness: 255
    moisture_threshold: 20
    battery_threshold: 10
    plants:
    - name: plant_1
      light: light.lounge_1
      moisture_sensor: sensor.plant_1_soil_moisture
      battery_sensor: sensor.plant_sensor_1_battery
    - name: plant_2
      light: light.lounge_2
      moisture_sensor: sensor.plant_2_soil_moisture
      battery_sensor: sensor.plant_sensor_2_battery
    - name: plant_3
      light: light.lounge_1
      moisture_sensor: sensor.plant_3_soil_moisture
      battery_sensor: sensor.plant_sensor_3_battery
    - name: plant_4
      light: light.lounge_1
      moisture_sensor: sensor.plant_4_soil_moisture
      battery_sensor: sensor.plant_sensor_4_battery
    - name: plant_5
      light: light.bathroom_1
      moisture_sensor: sensor.plant_5_soil_moisture
      battery_sensor: sensor.plant_sensor_5_battery
