- id: '1760852852321'
  alias: Plant Alerts - Deactivate (Auto Recovery)
  description: >
    Automatically turns off plant alert lights when plants recover.
    Runs every 5 minutes to check all lights and turns off a light only when
    ALL plants mapped to that light are healthy (above thresholds).
    Prevents missed updates and ensures multi-plant lights stay on until all recover.
  triggers:
  - minutes: /5
    trigger: time_pattern
  actions:
  - variables:
      unique_lights: >-
        {% set lights = namespace(list=[]) %}
        {% for p in plants %}
          {% if p.light not in lights.list %}
            {% set lights.list = lights.list + [p.light] %}
          {% endif %}
        {% endfor %}
        {{ lights.list }}
  - repeat:
      for_each: '{{ unique_lights }}'
      sequence:
      - variables:
          current_light: '{{ repeat.item }}'
          light_has_problems: >-
            {% set any_problem = false %}
            {% for p in plants %}
              {% if p.light == current_light %}
                {% set moist = states(p.moisture_sensor) | float(-1) %}
                {% set batt = states(p.battery_sensor) | float(100) %}
                {% if (moist >= 0 and moist < moisture_threshold) or (batt < 100 and batt < battery_threshold) %}
                  {% set any_problem = true %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {{ any_problem }}
      - choose:
        - conditions:
          - condition: template
            value_template: >-
              {{ (not light_has_problems) and (states(current_light) == 'on') }}
          sequence:
          - target:
              entity_id: '{{ current_light }}'
            action: light.turn_off
  mode: restart
  variables:
    moisture_threshold: 20
    battery_threshold: 10
    plants:
    - name: plant_1
      light: light.lounge_1
      moisture_sensor: sensor.plant_1_soil_moisture
      battery_sensor: sensor.plant_sensor_1_battery
    - name: plant_2
      light: light.lounge_2
      moisture_sensor: sensor.plant_2_soil_moisture
      battery_sensor: sensor.plant_sensor_2_battery
    - name: plant_3
      light: light.lounge_1
      moisture_sensor: sensor.plant_3_soil_moisture
      battery_sensor: sensor.plant_sensor_3_battery
    - name: plant_4
      light: light.lounge_1
      moisture_sensor: sensor.plant_4_soil_moisture
      battery_sensor: sensor.plant_sensor_4_battery
    - name: plant_5
      light: light.bathroom_1
      moisture_sensor: sensor.plant_5_soil_moisture
      battery_sensor: sensor.plant_sensor_5_battery
