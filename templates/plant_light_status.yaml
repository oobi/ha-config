# Plant Alert Light Status Sensors
# These sensors show which light is assigned to each plant and its current state

- sensor:
  - name: "Plant 1 Alert Light"
    unique_id: plant_1_alert_light
    state: >
      {% set cfg = state_attr('sensor.plant_alert_config', 'plants') %}
      {% set plants = cfg if cfg is iterable else [] %}
      {% set light = (plants | selectattr('name','equalto','plant_1') | map(attribute='light') | list | first) or 'light.lounge_1' %}
      {{ states(light) }}
    attributes:
      light_entity: >
        {% set cfg = state_attr('sensor.plant_alert_config', 'plants') %}
        {% set plants = cfg if cfg is iterable else [] %}
        {{ (plants | selectattr('name','equalto','plant_1') | map(attribute='light') | list | first) or 'light.lounge_1' }}
      light_name: >
        {% set cfg = state_attr('sensor.plant_alert_config', 'plants') %}
        {% set plants = cfg if cfg is iterable else [] %}
        {% set light = (plants | selectattr('name','equalto','plant_1') | map(attribute='light') | list | first) or 'light.lounge_1' %}
        {% if light == 'light.lounge_1' %}Lounge 1{% elif light == 'light.lounge_2' %}Lounge 2{% elif light == 'light.bathroom_1' %}Bathroom 1{% elif light == 'light.bathroom_3' %}Bathroom 3{% else %}{{ light }}{% endif %}
      color: >
        {% set cfg = state_attr('sensor.plant_alert_config', 'plants') %}
        {% set plants = cfg if cfg is iterable else [] %}
        {% set light = (plants | selectattr('name','equalto','plant_1') | map(attribute='light') | list | first) or 'light.lounge_1' %}
        {% if is_state(light, 'on') %}
          {{ state_attr(light, 'rgb_color') }}
        {% else %}
          null
        {% endif %}
      brightness: >
        {% set cfg = state_attr('sensor.plant_alert_config', 'plants') %}
        {% set plants = cfg if cfg is iterable else [] %}
        {% set light = (plants | selectattr('name','equalto','plant_1') | map(attribute='light') | list | first) or 'light.lounge_1' %}
        {{ state_attr(light, 'brightness') if is_state(light, 'on') else 0 }}
      shared_with: >
        {% set cfg = state_attr('sensor.plant_alert_config', 'plants') %}
        {% set plants = cfg if cfg is iterable else [] %}
        {% set light = (plants | selectattr('name','equalto','plant_1') | map(attribute='light') | list | first) or 'light.lounge_1' %}
        {% set others = plants | selectattr('light','equalto', light) | rejectattr('name','equalto','plant_1') | map(attribute='name') | list %}
        {{ others | join(', ') if others else 'none' }}
    icon: mdi:lightbulb

  - name: "Plant 2 Alert Light"
    unique_id: plant_2_alert_light
    state: >
      {% set cfg = state_attr('sensor.plant_alert_config', 'plants') %}
      {% set plants = cfg if cfg is iterable else [] %}
      {% set light = (plants | selectattr('name','equalto','plant_2') | map(attribute='light') | list | first) or 'light.lounge_2' %}
      {{ states(light) }}
    attributes:
      light_entity: >
        {% set cfg = state_attr('sensor.plant_alert_config', 'plants') %}
        {% set plants = cfg if cfg is iterable else [] %}
        {{ (plants | selectattr('name','equalto','plant_2') | map(attribute='light') | list | first) or 'light.lounge_2' }}
      light_name: >
        {% set cfg = state_attr('sensor.plant_alert_config', 'plants') %}
        {% set plants = cfg if cfg is iterable else [] %}
        {% set light = (plants | selectattr('name','equalto','plant_2') | map(attribute='light') | list | first) or 'light.lounge_2' %}
        {% if light == 'light.lounge_1' %}Lounge 1{% elif light == 'light.lounge_2' %}Lounge 2{% elif light == 'light.bathroom_1' %}Bathroom 1{% elif light == 'light.bathroom_3' %}Bathroom 3{% else %}{{ light }}{% endif %}
      color: >
        {% set cfg = state_attr('sensor.plant_alert_config', 'plants') %}
        {% set plants = cfg if cfg is iterable else [] %}
        {% set light = (plants | selectattr('name','equalto','plant_2') | map(attribute='light') | list | first) or 'light.lounge_2' %}
        {% if is_state(light, 'on') %}
          {{ state_attr(light, 'rgb_color') }}
        {% else %}
          null
        {% endif %}
      brightness: >
        {% set cfg = state_attr('sensor.plant_alert_config', 'plants') %}
        {% set plants = cfg if cfg is iterable else [] %}
        {% set light = (plants | selectattr('name','equalto','plant_2') | map(attribute='light') | list | first) or 'light.lounge_2' %}
        {{ state_attr(light, 'brightness') if is_state(light, 'on') else 0 }}
      shared_with: >
        {% set cfg = state_attr('sensor.plant_alert_config', 'plants') %}
        {% set plants = cfg if cfg is iterable else [] %}
        {% set light = (plants | selectattr('name','equalto','plant_2') | map(attribute='light') | list | first) or 'light.lounge_2' %}
        {% set others = plants | selectattr('light','equalto', light) | rejectattr('name','equalto','plant_2') | map(attribute='name') | list %}
        {{ others | join(', ') if others else 'none' }}
    icon: mdi:lightbulb

  - name: "Plant 3 Alert Light"
    unique_id: plant_3_alert_light
    state: >
      {% set cfg = state_attr('sensor.plant_alert_config', 'plants') %}
      {% set plants = cfg if cfg is iterable else [] %}
      {% set light = (plants | selectattr('name','equalto','plant_3') | map(attribute='light') | list | first) or 'light.lounge_1' %}
      {{ states(light) }}
    attributes:
      light_entity: >
        {% set cfg = state_attr('sensor.plant_alert_config', 'plants') %}
        {% set plants = cfg if cfg is iterable else [] %}
        {{ (plants | selectattr('name','equalto','plant_3') | map(attribute='light') | list | first) or 'light.lounge_1' }}
      light_name: >
        {% set cfg = state_attr('sensor.plant_alert_config', 'plants') %}
        {% set plants = cfg if cfg is iterable else [] %}
        {% set light = (plants | selectattr('name','equalto','plant_3') | map(attribute='light') | list | first) or 'light.lounge_1' %}
        {% if light == 'light.lounge_1' %}Lounge 1{% elif light == 'light.lounge_2' %}Lounge 2{% elif light == 'light.bathroom_1' %}Bathroom 1{% elif light == 'light.bathroom_3' %}Bathroom 3{% else %}{{ light }}{% endif %}
      color: >
        {% set cfg = state_attr('sensor.plant_alert_config', 'plants') %}
        {% set plants = cfg if cfg is iterable else [] %}
        {% set light = (plants | selectattr('name','equalto','plant_3') | map(attribute='light') | list | first) or 'light.lounge_1' %}
        {% if is_state(light, 'on') %}
          {{ state_attr(light, 'rgb_color') }}
        {% else %}
          null
        {% endif %}
      brightness: >
        {% set cfg = state_attr('sensor.plant_alert_config', 'plants') %}
        {% set plants = cfg if cfg is iterable else [] %}
        {% set light = (plants | selectattr('name','equalto','plant_3') | map(attribute='light') | list | first) or 'light.lounge_1' %}
        {{ state_attr(light, 'brightness') if is_state(light, 'on') else 0 }}
      shared_with: >
        {% set cfg = state_attr('sensor.plant_alert_config', 'plants') %}
        {% set plants = cfg if cfg is iterable else [] %}
        {% set light = (plants | selectattr('name','equalto','plant_3') | map(attribute='light') | list | first) or 'light.lounge_1' %}
        {% set others = plants | selectattr('light','equalto', light) | rejectattr('name','equalto','plant_3') | map(attribute='name') | list %}
        {{ others | join(', ') if others else 'none' }}
    icon: mdi:lightbulb

  - name: "Plant 4 Alert Light"
    unique_id: plant_4_alert_light
    state: >
      {% set cfg = state_attr('sensor.plant_alert_config', 'plants') %}
      {% set plants = cfg if cfg is iterable else [] %}
      {% set light = (plants | selectattr('name','equalto','plant_4') | map(attribute='light') | list | first) or 'light.lounge_1' %}
      {{ states(light) }}
    attributes:
      light_entity: >
        {% set cfg = state_attr('sensor.plant_alert_config', 'plants') %}
        {% set plants = cfg if cfg is iterable else [] %}
        {{ (plants | selectattr('name','equalto','plant_4') | map(attribute='light') | list | first) or 'light.lounge_1' }}
      light_name: >
        {% set cfg = state_attr('sensor.plant_alert_config', 'plants') %}
        {% set plants = cfg if cfg is iterable else [] %}
        {% set light = (plants | selectattr('name','equalto','plant_4') | map(attribute='light') | list | first) or 'light.lounge_1' %}
        {% if light == 'light.lounge_1' %}Lounge 1{% elif light == 'light.lounge_2' %}Lounge 2{% elif light == 'light.bathroom_1' %}Bathroom 1{% elif light == 'light.bathroom_3' %}Bathroom 3{% else %}{{ light }}{% endif %}
      color: >
        {% set cfg = state_attr('sensor.plant_alert_config', 'plants') %}
        {% set plants = cfg if cfg is iterable else [] %}
        {% set light = (plants | selectattr('name','equalto','plant_4') | map(attribute='light') | list | first) or 'light.lounge_1' %}
        {% if is_state(light, 'on') %}
          {{ state_attr(light, 'rgb_color') }}
        {% else %}
          null
        {% endif %}
      brightness: >
        {% set cfg = state_attr('sensor.plant_alert_config', 'plants') %}
        {% set plants = cfg if cfg is iterable else [] %}
        {% set light = (plants | selectattr('name','equalto','plant_4') | map(attribute='light') | list | first) or 'light.lounge_1' %}
        {{ state_attr(light, 'brightness') if is_state(light, 'on') else 0 }}
      shared_with: >
        {% set cfg = state_attr('sensor.plant_alert_config', 'plants') %}
        {% set plants = cfg if cfg is iterable else [] %}
        {% set light = (plants | selectattr('name','equalto','plant_4') | map(attribute='light') | list | first) or 'light.lounge_1' %}
        {% set others = plants | selectattr('light','equalto', light) | rejectattr('name','equalto','plant_4') | map(attribute='name') | list %}
        {{ others | join(', ') if others else 'none' }}
    icon: mdi:lightbulb

  - name: "Plant 5 Alert Light"
    unique_id: plant_5_alert_light
    state: >
      {% set cfg = state_attr('sensor.plant_alert_config', 'plants') %}
      {% set plants = cfg if cfg is iterable else [] %}
      {% set light = (plants | selectattr('name','equalto','plant_5') | map(attribute='light') | list | first) or 'light.bathroom_3' %}
      {{ states(light) }}
    attributes:
      light_entity: >
        {% set cfg = state_attr('sensor.plant_alert_config', 'plants') %}
        {% set plants = cfg if cfg is iterable else [] %}
        {{ (plants | selectattr('name','equalto','plant_5') | map(attribute='light') | list | first) or 'light.bathroom_3' }}
      light_name: >
        {% set cfg = state_attr('sensor.plant_alert_config', 'plants') %}
        {% set plants = cfg if cfg is iterable else [] %}
        {% set light = (plants | selectattr('name','equalto','plant_5') | map(attribute='light') | list | first) or 'light.bathroom_3' %}
        {% if light == 'light.lounge_1' %}Lounge 1{% elif light == 'light.lounge_2' %}Lounge 2{% elif light == 'light.bathroom_1' %}Bathroom 1{% elif light == 'light.bathroom_3' %}Bathroom 3{% else %}{{ light }}{% endif %}
      color: >
        {% set cfg = state_attr('sensor.plant_alert_config', 'plants') %}
        {% set plants = cfg if cfg is iterable else [] %}
        {% set light = (plants | selectattr('name','equalto','plant_5') | map(attribute='light') | list | first) or 'light.bathroom_3' %}
        {% if is_state(light, 'on') %}
          {{ state_attr(light, 'rgb_color') }}
        {% else %}
          null
        {% endif %}
      brightness: >
        {% set cfg = state_attr('sensor.plant_alert_config', 'plants') %}
        {% set plants = cfg if cfg is iterable else [] %}
        {% set light = (plants | selectattr('name','equalto','plant_5') | map(attribute='light') | list | first) or 'light.bathroom_3' %}
        {{ state_attr(light, 'brightness') if is_state(light, 'on') else 0 }}
      shared_with: >
        {% set cfg = state_attr('sensor.plant_alert_config', 'plants') %}
        {% set plants = cfg if cfg is iterable else [] %}
        {% set light = (plants | selectattr('name','equalto','plant_5') | map(attribute='light') | list | first) or 'light.bathroom_3' %}
        {% set others = plants | selectattr('light','equalto', light) | rejectattr('name','equalto','plant_5') | map(attribute='name') | list %}
        {{ others | join(', ') if others else 'none' }}
    icon: mdi:lightbulb

  - name: "Plant Alert Status Summary"
    unique_id: plant_alert_status_summary
    state: >
      {% set plants = state_attr('sensor.plant_alert_config', 'plants') or [] %}
      {% set ns = namespace(cnt=0) %}
      {% for n in plants | map(attribute='name') %}
        {% set pen = 'plant.' ~ n %}
        {% if states(pen) == 'problem' %}
          {% set ns.cnt = ns.cnt + 1 %}
        {% endif %}
      {% endfor %}
      {% if ns.cnt == 0 %}
        All healthy
      {% elif ns.cnt == 1 %}
        1 plant needs attention
      {% else %}
        {{ ns.cnt }} plants need attention
      {% endif %}
    attributes:
      light_lounge_1_status: >
        {% set plants = state_attr('sensor.plant_alert_config', 'plants') or [] %}
        {% set names = plants | selectattr('light','equalto','light.lounge_1') | map(attribute='name') | list %}
        {% set problems = [] %}
        {% for name in names %}
          {% set pen = 'plant.' ~ name %}
          {% if states(pen) == 'problem' %}
            {% set problems = problems + [ name ~ ' (' ~ (state_attr(pen,'problem') or 'problem') ~ ')' ] %}
          {% endif %}
        {% endfor %}
        {% if problems | length > 0 %}
          Problems: {{ problems | join(', ') }}
        {% else %}
          All healthy
        {% endif %}
      light_lounge_2_status: >
        {% set plants = state_attr('sensor.plant_alert_config', 'plants') or [] %}
        {% set names = plants | selectattr('light','equalto','light.lounge_2') | map(attribute='name') | list %}
        {% set problems = [] %}
        {% for name in names %}
          {% set pen = 'plant.' ~ name %}
          {% if states(pen) == 'problem' %}
            {% set problems = problems + [ name ~ ' (' ~ (state_attr(pen,'problem') or 'problem') ~ ')' ] %}
          {% endif %}
        {% endfor %}
        {% if problems | length > 0 %}
          Problems: {{ problems | join(', ') }}
        {% else %}
          All healthy
        {% endif %}
      light_bathroom_3_status: >
        {% set plants = state_attr('sensor.plant_alert_config', 'plants') or [] %}
        {% set names = plants | selectattr('light','equalto','light.bathroom_3') | map(attribute='name') | list %}
        {% set problems = [] %}
        {% for name in names %}
          {% set pen = 'plant.' ~ name %}
          {% if states(pen) == 'problem' %}
            {% set problems = problems + [ name ~ ' (' ~ (state_attr(pen,'problem') or 'problem') ~ ')' ] %}
          {% endif %}
        {% endfor %}
        {% if problems | length > 0 %}
          Problems: {{ problems | join(', ') }}
        {% else %}
          All healthy
        {% endif %}
    icon: mdi:flower-poppy
